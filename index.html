
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipefy Funnel Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0e1a;
            --card: #111827;
            --naranja: #f97316;
            --cyan: #06b6d4;
            --morado: #8b5cf6;
            --verde: #10b981;
            --rojo: #ef4444;
            --text: #f3f4f6;
            --text-muted: #9ca3af;
        }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #374151; padding-bottom: 10px; }
        .tab { padding: 10px 20px; cursor: pointer; border-radius: 8px; font-weight: 500; transition: 0.3s; }
        .tab:hover { background: #1f2937; }
        .tab.active { background: var(--naranja); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #1f2937; }
        .kpi-title { color: var(--text-muted); font-size: 0.875rem; margin-bottom: 8px; text-transform: uppercase; }
        .kpi-value { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
        .kpi-sub { font-size: 0.875rem; color: var(--cyan); }
        
        .chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .chart-full { width: 100%; margin-bottom: 20px; }
        canvas { width: 100% !important; }

        .toggle-btn { padding: 5px 15px; border-radius: 6px; border: 1px solid var(--naranja); background: transparent; color: var(--naranja); cursor: pointer; font-size: 0.75rem; margin-bottom: 10px; }
        .toggle-btn.active { background: var(--naranja); color: white; }
        
        .funnel-vis { display: flex; flex-direction: column; align-items: center; gap: 5px; margin-top: 20px; }
        .funnel-step { height: 40px; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 4px; transition: 0.3s; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Pipefy Funnel Dashboard</h1>
        <p style="color: var(--text-muted); margin-bottom: 30px;">Reporte actualizado al 10 de Febrero 2026</p>

        <div class="tabs">
            <div class="tab active" onclick="showTab('funnel')">Funnel</div>
            <div class="tab" onclick="showTab('comparativa')">Comparativa</div>
            <div class="tab" onclick="showTab('conversion')">Conversión</div>
        </div>

        <div id="funnel" class="tab-content active">
            <div class="kpi-grid">
                <div class="card"><div class="kpi-title">Total en Funnel</div><div class="kpi-value" id="kpi-total-b">0</div><div class="kpi-sub" id="kpi-total-m">$0</div></div>
                <div class="card"><div class="kpi-title">Pending Info</div><div class="kpi-value" id="kpi-info-b">0</div><div class="kpi-sub" id="kpi-info-m" style="color: var(--naranja)">$0</div></div>
                <div class="card"><div class="kpi-title">Pending Formalization</div><div class="kpi-value" id="kpi-form-b">0</div><div class="kpi-sub" id="kpi-form-m" style="color: var(--morado)">$0</div></div>
                <div class="card"><div class="kpi-title">Pending Signature</div><div class="kpi-value" id="kpi-sig-b">0</div><div class="kpi-sub" id="kpi-sig-m" style="color: var(--verde)">$0</div></div>
            </div>
            <div class="chart-row">
                <div class="card"><div class="kpi-title">Distribución por Etapa</div><canvas id="pieStages"></canvas></div>
                <div class="card"><div class="kpi-title">Documentos Faltantes (S1)</div><canvas id="barDocs"></canvas></div>
            </div>
            <div class="card chart-full">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="kpi-title">Desempeño por KAM</div>
                    <div>
                        <button class="toggle-btn active" id="btn-kam-b" onclick="updateKamChart('buyers')"># Buyers</button>
                        <button class="toggle-btn" id="btn-kam-m" onclick="updateKamChart('amount')">$ Monto</button>
                    </div>
                </div>
                <canvas id="barKam"></canvas>
            </div>
        </div>

        <div id="comparativa" class="tab-content">
            <div class="card chart-full"><div class="kpi-title">Evolución de Buyers (Sign Ups → Active)</div><canvas id="areaBuyers"></canvas></div>
            <div class="card chart-full"><div class="kpi-title">Evolución de Montos ($)</div><canvas id="barAmounts"></canvas></div>
        </div>

        <div id="conversion" class="tab-content">
            <div class="card chart-full"><div class="kpi-title">Tasas de Conversión (%)</div><canvas id="lineConv"></canvas></div>
            <div class="card" style="margin-top: 20px;"><div class="kpi-title">Embudo Visual (Feb-26)</div><div id="funnel-visual" class="funnel-vis"></div></div>
        </div>
    </div>

    <script>
        const data = {"kpis": {"total": {"buyers": 166, "amount": 92363600.0}, "pending_info": {"buyers": 113, "amount": 76314600.0}, "pending_form": {"buyers": 37, "amount": 12264000.0}, "pending_sig": {"buyers": 16, "amount": 3785000.0}}, "stages_pie": {"labels": ["Pending Information", "Pending Formalization", "Pending Signature"], "values": [113, 37, 16]}, "docs_bar": {"labels": ["SAT Connection", "Bur\u00f3 / Obligado", "Bank Statements"], "values": [90, 40, 11]}, "kam_data": {"labels": ["Benjamin Rodriguez Coronel", "Daniela Mazzochi", "Elizabeth Sanjuan", "Hector Oliveros", "Jorge Mendoza", "Lucy Alarc\u00f3n", "Unassigned"], "s1_buyers": [27, 2, 48, 0, 21, 15, 0], "s2_buyers": [10, 0, 18, 1, 4, 3, 1], "s3_buyers": [7, 0, 5, 0, 2, 2, 0], "s1_amount": [15169000.0, 7000000.0, 33621000.0, 0, 16034000.0, 4490600.0, 0], "s2_amount": [4530000.0, 0, 4854000.0, 200000.0, 1850000.0, 760000.0, 70000.0], "s3_amount": [1090000.0, 0, 745000.0, 0, 350000.0, 1600000.0, 0]}, "comparative": {"labels": ["Oct-25", "Nov-25", "Dec-25", "Jan-26", "Feb-26"], "signups": [319, 214, 133, 221, 67], "riskops": [159, 249, 145, 90, 141], "approved": [97, 124, 125, 115, 164], "active": [38, 42, 31, 27, 8], "amt_requested": [127244550.0, 92963899.0, 65244999.0, 135681432.0, 39522000.0], "amt_riskops": [100047550.0, 68008898.0, 50132000.0, 97160999.0, 45643000.0], "amt_approved": [32328000.0, 17343000.0, 11264000.0, 28865000.0, 7654000.0], "amt_active": [3057735.0, 2643462.0, 3274837.0, 1399392.0, 769024.0]}, "conversion": {"labels": ["Oct-25", "Nov-25", "Dec-25", "Jan-26", "Feb-26"], "risk_signup": [49.84, 116.36, 109.02, 40.72, 210.45], "approved_risk": [61.01, 49.8, 86.21, 127.78, 116.31], "amt_approved_risk": [32.31, 25.5, 22.47, 29.71, 16.77], "amt_active_approved": [9.46, 15.24, 29.07, 4.85, 10.05]}};
        function fmt(n) { return n.toLocaleString('en-US'); }
        function fmtCur(n) { return '$' + n.toLocaleString('en-US', {maximumFractionDigits:0}); }
        document.getElementById('kpi-total-b').innerText = data.kpis.total.buyers;
        document.getElementById('kpi-total-m').innerText = fmtCur(data.kpis.total.amount);
        document.getElementById('kpi-info-b').innerText = data.kpis.pending_info.buyers;
        document.getElementById('kpi-info-m').innerText = fmtCur(data.kpis.pending_info.amount);
        document.getElementById('kpi-form-b').innerText = data.kpis.pending_form.buyers;
        document.getElementById('kpi-form-m').innerText = fmtCur(data.kpis.pending_form.amount);
        document.getElementById('kpi-sig-b').innerText = data.kpis.pending_sig.buyers;
        document.getElementById('kpi-sig-m').innerText = fmtCur(data.kpis.pending_sig.amount);

        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        Chart.defaults.color = '#9ca3af';
        Chart.defaults.font.family = "'DM Sans', sans-serif";

        new Chart(document.getElementById('pieStages'), {
            type: 'doughnut',
            data: { labels: data.stages_pie.labels, datasets: [{ data: data.stages_pie.values, backgroundColor: ['#f97316', '#8b5cf6', '#10b981'], borderWidth: 0 }] },
            options: { plugins: { legend: { position: 'bottom' } } }
        });

        new Chart(document.getElementById('barDocs'), {
            type: 'bar',
            data: { labels: data.docs_bar.labels, datasets: [{ label: 'Buyers', data: data.docs_bar.values, backgroundColor: '#06b6d4', borderRadius: 4 }] },
            options: { indexAxis: 'y', plugins: { legend: { display: false } } }
        });

        let kamChart;
        function updateKamChart(mode) {
            const ctx = document.getElementById('barKam').getContext('2d');
            const isAmount = mode === 'amount';
            document.getElementById('btn-kam-b').classList.toggle('active', !isAmount);
            document.getElementById('btn-kam-m').classList.toggle('active', isAmount);
            const ds = [
                { label: 'Pending Info', data: isAmount ? data.kam_data.s1_amount : data.kam_data.s1_buyers, backgroundColor: '#f97316' },
                { label: 'Pending Formalization', data: isAmount ? data.kam_data.s2_amount : data.kam_data.s2_buyers, backgroundColor: '#8b5cf6' },
                { label: 'Pending Signature', data: isAmount ? data.kam_data.s3_amount : data.kam_data.s3_buyers, backgroundColor: '#10b981' }
            ];
            if (kamChart) kamChart.destroy();
            kamChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: data.kam_data.labels, datasets: ds },
                options: { scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: v => isAmount ? '$' + v/1000000 + 'M' : v } } }, plugins: { tooltip: { callbacks: { label: item => item.dataset.label + ': ' + (isAmount ? fmtCur(item.raw) : item.raw) } } } }
            });
        }
        updateKamChart('buyers');

        new Chart(document.getElementById('areaBuyers'), {
            type: 'line',
            data: { labels: data.comparative.labels, datasets: [
                { label: 'Sign Ups', data: data.comparative.signups, borderColor: '#f97316', fill: false, tension: 0.3 },
                { label: 'Risk Ops', data: data.comparative.riskops, borderColor: '#06b6d4', fill: false, tension: 0.3 },
                { label: 'Approved', data: data.comparative.approved, borderColor: '#8b5cf6', fill: false, tension: 0.3 },
                { label: 'Active', data: data.comparative.active, borderColor: '#10b981', fill: false, tension: 0.3 }
            ]}
        });

        new Chart(document.getElementById('barAmounts'), {
            type: 'bar',
            data: { labels: data.comparative.labels, datasets: [
                { label: '$ Requested', data: data.comparative.amt_requested, backgroundColor: '#374151' },
                { label: '$ Approved', data: data.comparative.amt_approved, backgroundColor: '#8b5cf6' },
                { label: '$ Active', data: data.comparative.amt_active, backgroundColor: '#10b981' }
            ]},
            options: { scales: { y: { ticks: { callback: v => '$' + v/1000000 + 'M' } } } }
        });

        new Chart(document.getElementById('lineConv'), {
            type: 'line',
            data: { labels: data.conversion.labels, datasets: [
                { label: '% Risk/SignUps', data: data.conversion.risk_signup, borderColor: '#f97316', tension: 0.3 },
                { label: '% Appr/Risk', data: data.conversion.approved_risk, borderColor: '#8b5cf6', tension: 0.3 },
                { label: '% $Active/$Appr', data: data.conversion.amt_active_approved, borderColor: '#10b981', tension: 0.3 }
            ]},
            options: { scales: { y: { ticks: { callback: v => v + '%' } } } }
        });

        const funnelDiv = document.getElementById('funnel-visual');
        const fData = [
            { label: 'Sign Ups', val: data.comparative.signups[4], color: '#f97316', width: 100 },
            { label: 'Risk Ops', val: data.comparative.riskops[4], color: '#06b6d4', width: 80 },
            { label: 'Approved', val: data.comparative.approved[4], color: '#8b5cf6', width: 60 },
            { label: 'Active', val: data.comparative.active[4], color: '#10b981', width: 40 }
        ];
        fData.forEach(s => {
            const step = document.createElement('div');
            step.className = 'funnel-step';
            step.style.width = s.width + '%';
            step.style.backgroundColor = s.color;
            step.innerHTML = `<span>${s.label}: ${s.val}</span>`;
            funnelDiv.appendChild(step);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kontempo ‚Äî Pipeline Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg: #07090f;
    --bg2: #0d1018;
    --bg3: #131720;
    --border: #1e2535;
    --orange: #FB8500;
    --cyan: #00d4ff;
    --purple: #5A3EEF;
    --green: #00e5a0;
    --red: #ff4757;
    --yellow: #ffd32a;
    --text: #e8eaf0;
    --muted: #6b7280;
    --card-r: 12px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14px; min-height: 100vh; }

  /* LOADER */
  #loader {
    position: fixed; inset: 0; background: var(--bg);
    display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999;
    gap: 16px;
  }
  .loader-ring {
    width: 48px; height: 48px; border: 3px solid var(--border);
    border-top-color: var(--orange); border-radius: 50%;
    animation: spin 0.9s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  #loader p { color: var(--muted); font-family: 'JetBrains Mono', monospace; font-size: 12px; }

  /* ERROR BANNER */
  #error-banner {
    display: none; background: #1a0a0a; border: 1px solid var(--red);
    color: var(--red); padding: 12px 20px; border-radius: 8px; margin: 20px;
    font-family: 'JetBrains Mono', monospace; font-size: 12px;
  }

  /* LAYOUT */
  #app { display: none; }
  header {
    padding: 20px 28px 0;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--border); padding-bottom: 16px;
  }
  .logo { font-family: 'Playfair Display', serif; font-size: 22px; font-weight: 700; color: var(--orange); letter-spacing: -0.5px; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .last-update { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--muted); }
  .refresh-btn {
    background: var(--bg3); border: 1px solid var(--border); color: var(--text);
    padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 13px;
    font-family: 'DM Sans', sans-serif; transition: all 0.2s;
  }
  .refresh-btn:hover { border-color: var(--orange); color: var(--orange); }

  main { padding: 20px 28px; }

  /* KPI ROW */
  .kpi-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px; }
  .kpi {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: var(--card-r); padding: 16px 18px;
    display: flex; flex-direction: column; gap: 4px;
  }
  .kpi.purple-bg { background: #1a1240; border-color: var(--purple); }
  .kpi.green-bg { background: #031a10; border-color: var(--green); }
  .kpi-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.6px; font-weight: 500; }
  .kpi-value { font-family: 'Playfair Display', serif; font-size: 26px; font-weight: 700; line-height: 1; }
  .kpi-sub { font-size: 11px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
  .kpi-value.orange { color: var(--orange); }
  .kpi-value.cyan { color: var(--cyan); }
  .kpi-value.red { color: var(--red); }
  .kpi-value.purple { color: var(--purple); }
  .kpi-value.green { color: var(--green); }

  /* CHARTS ROW */
  .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
  .chart-card {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: var(--card-r); padding: 18px;
  }
  .chart-title { font-family: 'Playfair Display', serif; font-size: 14px; font-weight: 600; margin-bottom: 14px; color: var(--text); }
  .chart-wrap { position: relative; height: 200px; }

  /* PRIORITY TABLE */
  .priority-card {
    background: var(--bg2); border: 1px solid var(--border);
    border-radius: var(--card-r); padding: 18px; margin-bottom: 20px;
  }
  .section-title { font-family: 'Playfair Display', serif; font-size: 15px; font-weight: 600; margin-bottom: 14px; }
  table { width: 100%; border-collapse: collapse; }
  th { font-size: 11px; text-transform: uppercase; letter-spacing: 0.6px; color: var(--muted); font-weight: 500; padding: 6px 10px; text-align: left; border-bottom: 1px solid var(--border); }
  td { padding: 8px 10px; border-bottom: 1px solid #0f1420; font-size: 13px; }
  tr:last-child td { border-bottom: none; }
  .buyer-id { font-family: 'JetBrains Mono', monospace; font-size: 11px; color: var(--muted); }
  .amount-cell { font-family: 'JetBrains Mono', monospace; font-weight: 500; color: var(--orange); }

  /* KAM TABS */
  .kam-section { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--card-r); padding: 18px; margin-bottom: 20px; }
  .kam-tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
  .kam-tab {
    background: var(--bg3); border: 1px solid var(--border); color: var(--muted);
    padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 13px;
    transition: all 0.2s; white-space: nowrap;
  }
  .kam-tab.active { background: var(--orange); border-color: var(--orange); color: #000; font-weight: 600; }
  .kam-tab:hover:not(.active) { border-color: var(--orange); color: var(--orange); }

  /* KAM CONTENT */
  .kam-content { display: none; }
  .kam-content.active { display: block; }
  .funnel-section { margin-bottom: 16px; }
  .funnel-header {
    display: flex; align-items: center; gap: 10px; padding: 8px 12px;
    background: var(--bg3); border-radius: 8px; margin-bottom: 8px; cursor: pointer;
  }
  .funnel-label { font-size: 13px; font-weight: 600; }
  .funnel-count {
    font-family: 'JetBrains Mono', monospace; font-size: 11px;
    background: var(--bg); padding: 2px 8px; border-radius: 10px; color: var(--muted);
  }
  .funnel-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .dot-info { background: var(--cyan); }
  .dot-risk { background: var(--yellow); }
  .dot-form { background: var(--purple); }
  .dot-sig { background: var(--green); }

  .buyer-card {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 14px; margin-bottom: 6px;
  }
  .buyer-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
  .buyer-name { font-weight: 500; font-size: 13px; }
  .buyer-merchant { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .buyer-amount { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--orange); }
  .chips { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
  .chip {
    font-size: 10px; padding: 2px 7px; border-radius: 4px; font-weight: 500;
    font-family: 'JetBrains Mono', monospace;
  }
  .chip-sat { background: #2a1a00; color: var(--orange); border: 1px solid #4a3000; }
  .chip-os { background: #0a1a2a; color: var(--cyan); border: 1px solid #0a3050; }
  .chip-edc { background: #1a0a2a; color: #c084fc; border: 1px solid #3a1a5a; }
  .chip-otros { background: #1a1a1a; color: var(--muted); border: 1px solid var(--border); }
  .badge { font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 500; }
  .badge-ok { background: #031a10; color: var(--green); border: 1px solid #0a4a2a; }
  .badge-pend { background: #1a1000; color: var(--yellow); border: 1px solid #4a3000; }
  .doc-field { font-size: 11px; color: var(--muted); margin-top: 4px; font-family: 'JetBrains Mono', monospace; }
  .sig-link { font-size: 11px; color: var(--muted); margin-top: 4px; word-break: break-all; font-family: 'JetBrains Mono', monospace; }

  .empty-state { text-align: center; padding: 24px; color: var(--muted); font-size: 13px; }

  @media (max-width: 900px) {
    .kpi-row { grid-template-columns: repeat(2, 1fr); }
    .charts-row { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div id="loader">
  <div class="loader-ring"></div>
  <p>Cargando pipeline desde Pipefy...</p>
</div>

<div id="error-banner"></div>

<div id="app">
  <header>
    <div class="logo">Kontempo</div>
    <div class="header-right">
      <span class="last-update" id="last-update">‚Äî</span>
      <button class="refresh-btn" onclick="loadData()">‚ü≥ Actualizar</button>
    </div>
  </header>

  <main>
    <!-- KPIs -->
    <div class="kpi-row">
      <div class="kpi">
        <div class="kpi-label">Total Funnel</div>
        <div class="kpi-value orange" id="kpi-total">‚Äî</div>
        <div class="kpi-sub">buyers activos</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Pending Information</div>
        <div class="kpi-value cyan" id="kpi-info">‚Äî</div>
        <div class="kpi-sub">buyers</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Risk Interview</div>
        <div class="kpi-value red" id="kpi-risk">‚Äî</div>
        <div class="kpi-sub">buyers</div>
      </div>
      <div class="kpi purple-bg">
        <div class="kpi-label">Pending Formalization</div>
        <div class="kpi-value purple" id="kpi-form">‚Äî</div>
        <div class="kpi-sub" id="kpi-form-amt">$ ‚Äî</div>
      </div>
      <div class="kpi green-bg">
        <div class="kpi-label">Pending Signature</div>
        <div class="kpi-value green" id="kpi-sig">‚Äî</div>
        <div class="kpi-sub" id="kpi-sig-amt">$ ‚Äî</div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="charts-row">
      <div class="chart-card">
        <div class="chart-title">Pending Information ‚Äî Desglose por Documento</div>
        <div class="chart-wrap"><canvas id="chartDocs"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Pipeline por KAM ($ MXN)</div>
        <div class="chart-wrap"><canvas id="chartKam"></canvas></div>
      </div>
    </div>

    <!-- PRIORITY TABLE -->
    <div class="priority-card">
      <div class="section-title">Priority Cards (&gt;200K, SAT S√≠, NO Obligado)</div>
      <table>
        <thead>
          <tr>
            <th>Buyer ID</th>
            <th>Buyer</th>
            <th>Requested Amount</th>
          </tr>
        </thead>
        <tbody id="priority-tbody"></tbody>
      </table>
    </div>

    <!-- KAM TABS -->
    <div class="kam-section">
      <div class="section-title">Pipeline por KAM</div>
      <div class="kam-tabs" id="kam-tabs"></div>
      <div id="kam-contents"></div>
    </div>
  </main>
</div>

<script>
const TOKEN = 'eyJhbGciOiJIUzUxMiJ9.eyJpc3MiOiJQaXBlZnkiLCJpYXQiOjE3Njk3NTE1MTMsImp0aSI6ImQ4YmM3OWJhLWQ3YzAtNGQ2ZC1hYWNlLTk4NWExMDAyZGVhZSIsInN1YiI6MzA2NjUxNTY5LCJ1c2VyIjp7ImlkIjozMDY2NTE1NjksImVtYWlsIjoibGF1cmEuYW5ndWlhbm9Aa29udGVtcG8uaW8ifSwidXNlcl90eXBlIjoiYXV0aGVudGljYXRlZCJ9.32ONOzY1ccY1K9Yhj4oDQPFnCVw8ozZtv9Lm950516rXcX7y-_d4Z8mRreW_EpPOhuTchsQgwg9SeoQOMnoHzQ';
const PIPE_ID = '304500848';

const PHASE_MAP = {
  'Pending Information (Warehouse)': 'info',
  'Risk Interview': 'risk',
  'Approved - Pending Formalization Documents (Warehouse)': 'form',
  'Approved - Pending Signature (Warehouse)': 'sig'
};

let chartsInstances = {};

async function pipefy(query, variables = {}) {
  const res = await fetch('https://api.pipefy.com/graphql', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${TOKEN}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ query, variables })
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  if (data.errors) throw new Error(data.errors[0].message);
  return data.data;
}

// Get pipe phases IDs
async function getPhaseIds() {
  const q = `{ pipe(id: ${PIPE_ID}) { phases { id name } } }`;
  const data = await pipefy(q);
  const phases = {};
  for (const p of data.pipe.phases) {
    if (PHASE_MAP[p.name]) phases[PHASE_MAP[p.name]] = p.id;
  }
  return phases;
}

// Get all cards from a phase (paginated)
async function getPhaseCards(phaseId) {
  let cards = [];
  let cursor = null;
  let hasMore = true;
  while (hasMore) {
    const q = `
      query($phaseId: ID!, $after: String) {
        phase(id: $phaseId) {
          cards(first: 50, after: $after) {
            pageInfo { hasNextPage endCursor }
            edges {
              node {
                id title
                fields { name value array_value }
                assignees { name }
              }
            }
          }
        }
      }
    `;
    const data = await pipefy(q, { phaseId, after: cursor });
    const page = data.phase.cards;
    cards.push(...page.edges.map(e => e.node));
    hasMore = page.pageInfo.hasNextPage;
    cursor = page.pageInfo.endCursor;
  }
  return cards;
}

function getField(card, name) {
  const f = card.fields.find(f => f.name === name);
  return f ? (f.value || '') : '';
}

function fmtMXN(n) {
  if (!n) return '‚Äî';
  return '$ ' + Number(n).toLocaleString('es-MX', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function detectDocs(pendingText) {
  const t = (pendingText || '').toLowerCase();
  const hasSAT = t.includes('constancia') || t.includes('csf') || t.includes('situaci√≥n fiscal') || t.includes('situacion fiscal') || t.includes('sat');
  const hasOS = t.includes('obligado solidario') || t.includes('43qumym') || t.includes('bur√≥') || t.includes('buro') || t.includes('os link');
  const hasEDC = (t.includes('estado') && t.includes('cuenta')) || t.includes('edc');
  return { hasSAT, hasOS, hasEDC };
}

function getDocChips(card, phase) {
  let pendingText = '';
  if (phase === 'info') pendingText = getField(card, 'Pending Information Requirements - Completed at') + ' ' + getField(card, 'PENDING DOCUMENTS:') + ' ' + getField(card, 'Pending Documents');
  if (phase === 'form') pendingText = getField(card, 'Formalization Pending Documents') + ' ' + getField(card, 'Pending Documents');
  // Also check all fields for pending-like content
  if (!pendingText.trim()) {
    const f = card.fields.find(f => f.name && f.name.toLowerCase().includes('pending'));
    if (f) pendingText = f.value || '';
  }
  const { hasSAT, hasOS, hasEDC } = detectDocs(pendingText);
  const chips = [];
  if (hasSAT && hasOS) return [{ label: 'Falta SAT+OS', cls: 'chip-sat' }];
  if (hasSAT) chips.push({ label: 'Falta SAT', cls: 'chip-sat' });
  if (hasOS) chips.push({ label: 'Falta OS', cls: 'chip-os' });
  if (hasEDC) chips.push({ label: 'Falta EDC/Otros', cls: 'chip-edc' });
  if (chips.length === 0) chips.push({ label: 'Otros', cls: 'chip-otros' });
  return chips;
}

function getKAM(card) {
  // Try assignees first
  if (card.assignees && card.assignees.length > 0) return card.assignees[0].name;
  const f = card.fields.find(f => f.name && (f.name.includes('KAM') || f.name.includes('Customer Success')));
  return f ? (f.value || 'Sin KAM') : 'Sin KAM';
}

function getAmount(card, field) {
  const f = card.fields.find(f => f.name === field);
  if (!f) return 0;
  const v = (f.value || '').replace(/[^0-9.]/g, '');
  return parseFloat(v) || 0;
}

function renderChart(id, type, data, options) {
  if (chartsInstances[id]) chartsInstances[id].destroy();
  const ctx = document.getElementById(id).getContext('2d');
  chartsInstances[id] = new Chart(ctx, { type, data, options });
}

function renderDashboard(allCards) {
  const info = allCards.filter(c => c._phase === 'info');
  const risk = allCards.filter(c => c._phase === 'risk');
  const form = allCards.filter(c => c._phase === 'form');
  const sig  = allCards.filter(c => c._phase === 'sig');

  // KPIs
  document.getElementById('kpi-total').textContent = allCards.length;
  document.getElementById('kpi-info').textContent = info.length;
  document.getElementById('kpi-risk').textContent = risk.length;
  document.getElementById('kpi-form').textContent = form.length;
  document.getElementById('kpi-sig').textContent = sig.length;

  const formAmt = form.reduce((s, c) => s + getAmount(c, 'Amount Approved - Credit Analysis'), 0);
  const sigAmt  = sig.reduce((s, c)  => s + getAmount(c, 'Amount Approved - Credit Analysis'), 0);
  document.getElementById('kpi-form-amt').textContent = fmtMXN(formAmt);
  document.getElementById('kpi-sig-amt').textContent  = fmtMXN(sigAmt);

  // Docs chart
  const docCounts = { 'Falta SAT': 0, 'Falta OS': 0, 'Falta SAT+OS': 0, 'Falta EDC/Otros': 0, 'Otros': 0 };
  for (const c of info) {
    const chips = getDocChips(c, 'info');
    for (const ch of chips) {
      const k = ch.label;
      if (docCounts[k] !== undefined) docCounts[k]++;
      else docCounts['Otros']++;
    }
  }
  renderChart('chartDocs', 'bar', {
    labels: Object.keys(docCounts),
    datasets: [{ data: Object.values(docCounts), backgroundColor: ['#FB8500','#00d4ff','#5A3EEF','#c084fc','#6b7280'], borderRadius: 4, borderSkipped: false }]
  }, {
    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      x: { grid: { color: '#1e2535' }, ticks: { color: '#6b7280', font: { family: 'JetBrains Mono', size: 10 } } },
      y: { grid: { display: false }, ticks: { color: '#e8eaf0', font: { family: 'DM Sans', size: 11 } } }
    }
  });

  // KAM pipeline chart
  const kamAmounts = {};
  const phaseColors = { info: '#00d4ff', risk: '#ffd32a', form: '#5A3EEF', sig: '#00e5a0' };
  for (const c of allCards) {
    const kam = getKAM(c);
    if (!kamAmounts[kam]) kamAmounts[kam] = { info: 0, risk: 0, form: 0, sig: 0 };
    const amt = getAmount(c, 'Amount Requested') || getAmount(c, 'Amount Approved - Credit Analysis');
    kamAmounts[kam][c._phase] += amt;
  }
  const kamNames = Object.keys(kamAmounts);
  renderChart('chartKam', 'bar', {
    labels: kamNames.map(k => k.split(' ')[0]),
    datasets: [
      { label: 'Information', data: kamNames.map(k => kamAmounts[k].info), backgroundColor: phaseColors.info, borderRadius: 2 },
      { label: 'Risk', data: kamNames.map(k => kamAmounts[k].risk), backgroundColor: phaseColors.risk, borderRadius: 2 },
      { label: 'Formalization', data: kamNames.map(k => kamAmounts[k].form), backgroundColor: phaseColors.form, borderRadius: 2 },
      { label: 'Signature', data: kamNames.map(k => kamAmounts[k].sig), backgroundColor: phaseColors.sig, borderRadius: 2 }
    ]
  }, {
    responsive: true, maintainAspectRatio: false,
    plugins: {
      legend: { labels: { color: '#6b7280', font: { family: 'DM Sans', size: 11 }, boxWidth: 10 } },
      tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label}: ${fmtMXN(ctx.raw)}` } }
    },
    scales: {
      x: { stacked: true, grid: { display: false }, ticks: { color: '#e8eaf0', font: { family: 'DM Sans', size: 11 } } },
      y: { stacked: true, grid: { color: '#1e2535' }, ticks: { color: '#6b7280', font: { family: 'JetBrains Mono', size: 10 }, callback: v => v >= 1000000 ? (v/1000000).toFixed(1)+'M' : v >= 1000 ? (v/1000).toFixed(0)+'K' : v } }
    }
  });

  // Priority table
  const priority = info.filter(c => {
    const amt = getAmount(c, 'Amount Requested') || getAmount(c, 'Amount Approved - Credit Analysis');
    const chips = getDocChips(c, 'info');
    const hasSAT = chips.some(ch => ch.label.includes('SAT'));
    const hasOS = chips.some(ch => ch.label.includes('OS'));
    return amt > 200000 && hasSAT && !hasOS;
  }).sort((a, b) => {
    const aAmt = getAmount(a, 'Amount Requested') || getAmount(a, 'Amount Approved - Credit Analysis');
    const bAmt = getAmount(b, 'Amount Requested') || getAmount(b, 'Amount Approved - Credit Analysis');
    return bAmt - aAmt;
  });

  const tbody = document.getElementById('priority-tbody');
  if (priority.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No hay priority cards en este momento</td></tr>';
  } else {
    tbody.innerHTML = priority.map(c => {
      const buyerId = getField(c, 'Buyer Account ID') || c.id;
      const amt = getAmount(c, 'Amount Requested') || getAmount(c, 'Amount Approved - Credit Analysis');
      return `<tr>
        <td class="buyer-id">${buyerId}</td>
        <td>${c.title}</td>
        <td class="amount-cell">${fmtMXN(amt)}</td>
      </tr>`;
    }).join('');
  }

  // KAM tabs
  // Group by KAM, then by merchant, order: sig > form > risk > info
  const kamGroups = {};
  for (const c of allCards) {
    const kam = getKAM(c);
    if (!kamGroups[kam]) kamGroups[kam] = [];
    kamGroups[kam].push(c);
  }

  const tabsEl = document.getElementById('kam-tabs');
  const contentsEl = document.getElementById('kam-contents');
  tabsEl.innerHTML = '';
  contentsEl.innerHTML = '';

  const kamList = Object.keys(kamGroups).sort();
  kamList.forEach((kam, i) => {
    const tab = document.createElement('div');
    tab.className = 'kam-tab' + (i === 0 ? ' active' : '');
    tab.textContent = kam.split(' ')[0] + ' (' + kamGroups[kam].length + ')';
    tab.onclick = () => {
      document.querySelectorAll('.kam-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.kam-content').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById('kam-' + i).classList.add('active');
    };
    tabsEl.appendChild(tab);

    const content = document.createElement('div');
    content.className = 'kam-content' + (i === 0 ? ' active' : '');
    content.id = 'kam-' + i;
    content.innerHTML = renderKamContent(kamGroups[kam]);
    contentsEl.appendChild(content);
  });

  // Update time
  document.getElementById('last-update').textContent = 'Actualizado: ' + new Date().toLocaleTimeString('es-MX');
}

function renderKamContent(cards) {
  const phases = [
    { key: 'sig',  label: 'Approved - Pending Signature',       dot: 'dot-sig' },
    { key: 'form', label: 'Approved - Pending Formalization Documents', dot: 'dot-form' },
    { key: 'risk', label: 'Risk Interview',                      dot: 'dot-risk' },
    { key: 'info', label: 'Pending Information',                 dot: 'dot-info' },
  ];

  let html = '';
  for (const phase of phases) {
    const phaseCards = cards.filter(c => c._phase === phase.key);
    if (phaseCards.length === 0) continue;

    // Group by merchant
    const merchants = {};
    for (const c of phaseCards) {
      const m = getField(c, 'Merchant Name') || 'Sin Merchant';
      if (!merchants[m]) merchants[m] = [];
      merchants[m].push(c);
    }

    html += `<div class="funnel-section">
      <div class="funnel-header">
        <div class="funnel-dot ${phase.dot}"></div>
        <div class="funnel-label">${phase.label}</div>
        <div class="funnel-count">${phaseCards.length} buyers</div>
      </div>`;

    for (const [merchant, mCards] of Object.entries(merchants)) {
      html += `<div style="margin-left:18px; margin-bottom:8px">
        <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:0.6px;margin-bottom:4px;padding-left:4px">${merchant}</div>`;
      for (const c of mCards) {
        html += renderBuyerCard(c, phase.key);
      }
      html += `</div>`;
    }
    html += `</div>`;
  }
  return html || '<div class="empty-state">Sin cards en este KAM</div>';
}

function renderBuyerCard(card, phase) {
  const buyerId = getField(card, 'Buyer Account ID') || card.id;
  const reqAmt = getAmount(card, 'Amount Requested');
  const approvedAmt = getAmount(card, 'Amount Approved - Credit Analysis');
  const folder = getField(card, 'Buyer Drive Folder - Link');

  let extra = '';

  if (phase === 'info' || phase === 'form') {
    const chips = getDocChips(card, phase);
    extra = `<div class="chips">${chips.map(ch => `<span class="chip ${ch.cls}">${ch.label}</span>`).join('')}</div>`;
    if (folder) extra += `<div class="doc-field">üìÅ ${folder}</div>`;
  }

  if (phase === 'risk') {
    const entrevista = getField(card, 'Notas - Request Review') || getField(card, 'Notas - Request Review CS/CX') || '';
    const agendada = entrevista.toLowerCase().includes('agenda') || entrevista.toLowerCase().includes('schedul');
    extra = `<div class="chips"><span class="badge ${agendada ? 'badge-ok' : 'badge-pend'}">${agendada ? '‚úì entrevista agendada' : '‚è≥ pendiente'}</span></div>`;
  }

  if (phase === 'sig') {
    const osLink = getField(card, 'OS Link');
    const driveLink = folder;
    if (osLink) extra += `<div class="sig-link">OS: ${osLink}</div>`;
    if (driveLink) extra += `<div class="sig-link">Drive: ${driveLink}</div>`;
  }

  const displayAmt = approvedAmt || reqAmt;

  return `<div class="buyer-card">
    <div class="buyer-card-header">
      <div>
        <div class="buyer-name">${card.title}</div>
        <div class="buyer-id">${buyerId}</div>
      </div>
      ${displayAmt ? `<div class="buyer-amount">${fmtMXN(displayAmt)}</div>` : ''}
    </div>
    ${extra}
  </div>`;
}

async function loadData() {
  document.getElementById('loader').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  document.getElementById('error-banner').style.display = 'none';

  try {
    const phaseIds = await getPhaseIds();
    const missing = Object.keys(PHASE_MAP).filter(name => {
      const key = PHASE_MAP[name];
      return !phaseIds[key];
    });
    if (missing.length > 0) {
      console.warn('Fases no encontradas:', missing);
    }

    const allCards = [];
    for (const [phaseKey, phaseId] of Object.entries(phaseIds)) {
      if (!phaseId) continue;
      const cards = await getPhaseCards(phaseId);
      cards.forEach(c => c._phase = phaseKey);
      allCards.push(...cards);
    }

    renderDashboard(allCards);
    document.getElementById('loader').style.display = 'none';
    document.getElementById('app').style.display = 'block';
  } catch (err) {
    document.getElementById('loader').style.display = 'none';
    const banner = document.getElementById('error-banner');
    banner.style.display = 'block';
    banner.textContent = '‚ö† Error cargando datos: ' + err.message + '. Verifica tu token y conexi√≥n a Pipefy.';
    document.getElementById('app').style.display = 'block';
  }
}

loadData();
</script>
</body>
</html>
